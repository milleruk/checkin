{% extends "sbadmin/base.html" %}
{% block title %}User Details{% endblock %}

{% block content %}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
  <div>
    <h1 class="h3 mb-0 text-gray-800">{{ user.username }}</h1>
    <div class="small text-muted">User details & site assignments</div>
  </div>
  <div>
    <a href="{% url 'superuser_user_list' %}" class="btn btn-sm btn-outline-secondary">
      <i class="fas fa-arrow-left mr-1"></i> Back to users
    </a>
  </div>
</div>

<div class="row">
  <!-- User summary -->
  <div class="col-lg-5 mb-4">
    <div class="card shadow">
      <div class="card-header py-3 d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <i class="fas fa-user text-primary mr-2"></i>
          <h6 class="m-0 font-weight-bold text-primary">User Summary</h6>
        </div>
        <span class="badge badge-{% if user.is_active %}success{% else %}secondary{% endif %}">
          {% if user.is_active %}Active{% else %}Inactive{% endif %}
        </span>
      </div>

      <div class="card-body small">
        <div class="mb-2"><strong>Username:</strong> {{ user.username }}</div>
        <div class="mb-2"><strong>First Name:</strong> {{ user.first_name|default_if_none:"" }}</div>
        <div class="mb-2"><strong>Last Name:</strong> {{ user.last_name|default_if_none:"" }}</div>
        <div class="mb-2"><strong>Email:</strong> <span class="text-muted">{{ user.email|default:"—" }}</span></div>
        <div class="mb-2">
          <strong>Role:</strong>
          {% if user.is_superuser %}
            <span class="badge badge-danger ml-1">Superuser</span>
          {% else %}
            <span class="badge badge-light ml-1">User</span>
          {% endif %}
        </div>
        <div class="mb-0"><strong>User ID:</strong> {{ user.id }}</div>
      </div>
    </div>
  </div>

  <!-- Sites managed -->
  <div class="col-lg-7 mb-4">
    <div class="card shadow">
      <div class="card-header py-3 d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <i class="fas fa-building text-primary mr-2"></i>
          <h6 class="m-0 font-weight-bold text-primary">Sites Managed</h6>
          <span class="badge badge-pill badge-light ml-2">{{ sites|length }}</span>
        </div>
        <div style="min-width:260px;">
          <input type="text" id="siteFilter" class="form-control form-control-sm" placeholder="Search sites…">
        </div>
      </div>

      <div class="card-body p-0">
        <form method="post" class="p-3 border-bottom">
          {% csrf_token %}
          <div class="form-row align-items-end">
            <div class="col">
              {{ add_form.site.label_tag }}
              {{ add_form.site }}
            </div>
            <div class="col-auto">
              <button type="submit" name="add_site" class="btn btn-sm btn-success">Add to Site</button>
            </div>
          </div>
        </form>
        {% if sites %}
          <div class="list-group list-group-flush" id="siteList">
            {% for site in sites %}
              <form method="post" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center p-0 border-0">
                {% csrf_token %}
                <a href="{% url 'superuser_site_detail' site.id %}"
                   class="d-block flex-grow-1 py-3 px-3"
                   data-site-text="{{ site.name|lower }} {{ site.address|default:''|lower }}">
                  <div class="font-weight-bold text-gray-800">{{ site.name }}</div>
                  {% if site.address %}
                    <div class="small text-muted">{{ site.address }}</div>
                  {% endif %}
                </a>
                <span class="badge badge-{% if site.is_active %}success{% else %}secondary{% endif %} mr-3">
                  {% if site.is_active %}Active{% else %}Inactive{% endif %}
                </span>
                <button type="submit" name="remove_site_id" value="{{ site.id }}" class="btn btn-sm btn-outline-danger mr-3">Remove</button>
                <!-- PIN management removed -->
              </form>
            {% endfor %}
          </div>

          <div id="noSiteResults" class="text-center text-muted py-4" style="display:none;">
            No matching sites.
          </div>
        {% else %}
          <div class="p-4">
            <div class="alert alert-info mb-0">No sites assigned.</div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  var input = document.getElementById('siteFilter');
  var list = document.getElementById('siteList');
  var noRes = document.getElementById('noSiteResults');

  function applyFilter() {
    if (!input || !list) return;
    var q = (input.value || '').toLowerCase().trim();
    var items = list.querySelectorAll('[data-site-text]');
    var visible = 0;

    items.forEach(function(item){
      var text = item.getAttribute('data-site-text') || '';
      var show = (!q) || text.indexOf(q) !== -1;
      item.style.display = show ? '' : 'none';
      if (show) visible++;
    });

    if (noRes) noRes.style.display = (items.length > 0 && visible === 0) ? '' : 'none';
  }

  if (input) input.addEventListener('input', applyFilter);
})();
</script>
{% endblock %}
