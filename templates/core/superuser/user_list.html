{% extends "sbadmin/base.html" %}
{% block title %}All Users{% endblock %}

{% block content %}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
  <div>
    <h1 class="h3 mb-0 text-gray-800">All Users</h1>
    <div class="small text-muted">User directory + site manager assignments</div>
  </div>
  <div class="d-flex align-items-center">
    <span class="badge badge-pill badge-light mr-3">{{ users|length }}</span>
    <a href="{% url 'superuser_admin' %}" class="btn btn-sm btn-outline-secondary">
      <i class="fas fa-arrow-left mr-1"></i> Back
    </a>
  </div>
</div>

<div class="card shadow mb-4">
  <div class="card-header py-3 d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center">
      <i class="fas fa-users text-primary mr-2"></i>
      <h6 class="m-0 font-weight-bold text-primary">Users</h6>
    </div>
    <div style="min-width:260px;">
      <input type="text" id="userFilter" class="form-control form-control-sm" placeholder="Search username / email / site…">
    </div>
  </div>

  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm table-hover mb-0" id="usersTable">
        <thead class="thead-light">
          <tr>
            <th class="pl-3">ID</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Email</th>
            <th>Active</th>
            <th>Role</th>
            <th>Sites Managed</th>
            <th class="text-right pr-3"></th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr>
            <td class="pl-3">
              <div class="small text-muted">{{ user.id }}</div>
            </td>
            <td>{{ user.first_name|default_if_none:"" }}</td>
            <td>{{ user.last_name|default_if_none:"" }}</td>
            <td>{{ user.email|default_if_none:"—" }}</td>
            <td>
              {% if user.is_active %}
                <span class="badge badge-success">Active</span>
              {% else %}
                <span class="badge badge-secondary">Inactive</span>
              {% endif %}
            </td>
            <td>
              {% if user.is_superuser %}
                <span class="badge badge-danger">Superuser</span>
              {% else %}
                <span class="badge badge-light">User</span>
              {% endif %}
            </td>
            <td>
              {% if user.sites %}
                <span class="small">{{ user.sites|join:', ' }}</span>
              {% else %}
                <span class="text-muted small">—</span>
              {% endif %}
            </td>
            <td class="text-right pr-3">
              <a class="btn btn-sm btn-outline-info" href="{% url 'superuser_user_detail' user.id %}">
                <i class="fas fa-search mr-1"></i> Details
              </a>
            </td>
          </tr>
          {% empty %}
            <tr><td colspan="6" class="text-muted py-4 text-center">No users found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div id="noUserResults" class="text-center text-muted py-4" style="display:none;">
      No matching users.
    </div>
  </div>
</div>

<script>
(function () {
  var input = document.getElementById('userFilter');
  var table = document.getElementById('usersTable');
  var noRes = document.getElementById('noUserResults');

  function applyFilter() {
    if (!input || !table) return;
    var q = (input.value || '').toLowerCase().trim();
    var rows = table.querySelectorAll('tbody tr');
    var visible = 0;

    rows.forEach(function(row){
      var text = (row.innerText || '').toLowerCase();
      var show = (!q) || text.indexOf(q) !== -1;
      row.style.display = show ? '' : 'none';
      if (show) visible++;
    });

    if (noRes) noRes.style.display = (rows.length > 0 && visible === 0) ? '' : 'none';
  }

  if (input) input.addEventListener('input', applyFilter);
})();
</script>
{% endblock %}
