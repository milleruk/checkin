{% extends "sbadmin/base.html" %}
{% block title %}Rotate Site Token - {{ site.name }}{% endblock %}

{% block content %}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
  <div>
    <h1 class="h3 mb-0 text-gray-800">Rotate Site Token</h1>
    <div class="small text-muted">{{ site.name }}</div>
  </div>
  <a href="{% url 'site_settings' site.id %}" class="btn btn-sm btn-outline-secondary">
    <i class="fas fa-arrow-left mr-1"></i> Back to Settings
  </a>
</div>

<div class="row">
  <!-- LEFT: Rotate -->
  <div class="col-lg-5 col-xl-4 mb-4">
    <div class="card shadow border-left-danger h-100">
      <div class="card-header py-3 d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <i class="fas fa-sync-alt text-danger mr-2"></i>
          <h6 class="m-0 font-weight-bold text-danger">Rotate Token</h6>
        </div>
        <span class="badge badge-danger">Destructive</span>
      </div>

      <div class="card-body">
        <div class="alert alert-warning small mb-3">
          <strong>This will invalidate existing QR/portal links.</strong><br>
          After rotating, reprint/update any posters, badges, or saved links.
        </div>

        <form method="post" id="rotateForm">
          {% csrf_token %}
          <div class="form-group">
            <label>Select tokens to rotate:</label>
            {% for token in tokens %}
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="token_types" id="token_{{ token.type }}" value="{{ token.type }}">
                <label class="form-check-label" for="token_{{ token.type }}">
                  {{ token.get_type_display }}
                </label>
              </div>
            {% endfor %}
          </div>
          <div class="form-group form-check mt-3">
            <input type="checkbox" class="form-check-input" id="confirmRotate" name="confirm">
            <label class="form-check-label" for="confirmRotate">Confirm rotation</label>
          </div>
          <button type="button" class="btn btn-danger btn-block" data-toggle="modal" data-target="#confirmRotateModal">
            <i class="fas fa-sync-alt mr-1"></i> Rotate Selected Tokens
          </button>
        </form>

        <div class="text-muted small mt-3">
          Tip: Rotate tokens if a QR poster is lost, printed publicly, or you suspect the link was shared.
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT: Current tokens -->
  <div class="col-lg-7 col-xl-8 mb-4">
    <div class="card shadow h-100">
      <div class="card-header py-3 d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <i class="fas fa-key text-primary mr-2"></i>
          <h6 class="m-0 font-weight-bold text-primary">Current Tokens</h6>
        </div>
        <span class="small text-muted">Keep these private</span>
      </div>

      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="thead-light">
              <tr>
                <th class="pl-3">Type</th>
                <th>Token</th>
                <th class="text-right pr-3" style="width:120px;">Copy</th>
              </tr>
            </thead>
            <tbody>
              {% for token in tokens %}
                <tr>
                  <td class="pl-3">
                    <span class="font-weight-bold">{{ token.get_type_display }}</span>
                  </td>
                  <td>
                    <code class="token-value" style="font-size:.95rem; word-break:break-all;">
                      {{ token.token }}
                    </code>
                  </td>
                  <td class="text-right pr-3">
                    <button type="button"
                            class="btn btn-sm btn-outline-primary copyTokenBtn"
                            data-token="{{ token.token|escapejs }}">
                      <i class="fas fa-copy mr-1"></i> Copy
                    </button>
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="3" class="text-muted py-3 pl-3">No tokens found.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="card-footer bg-white">
        <div class="small text-muted">
          If you rotate a token, the old one stops working immediately.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Confirm modal -->
<div class="modal fade" id="confirmRotateModal" tabindex="-1" role="dialog" aria-labelledby="confirmRotateModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmRotateModalLabel">Confirm Token Rotation</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Rotating will invalidate existing posters/links immediately.
        <strong>Are you sure you want to rotate the token?</strong>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger btn-sm" id="confirmRotateBtn">
          <i class="fas fa-sync-alt mr-1"></i> Yes, Rotate
        </button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // Confirm rotate submits the form
  var confirmRotateBtn = document.getElementById('confirmRotateBtn');
  if (confirmRotateBtn) {
    confirmRotateBtn.addEventListener('click', function(e){
      var checked = document.querySelectorAll('#rotateForm input[name="token_types"]:checked').length;
      if (!checked) {
        alert('Please select at least one token to rotate.');
        return;
      }
      var confirmChecked = document.getElementById('confirmRotate').checked;
      if (!confirmChecked) {
        alert('You must tick the Confirm rotation box.');
        return;
      }
      document.getElementById('rotateForm').submit();
    });
  }

  // Copy token buttons
  document.querySelectorAll('.copyTokenBtn').forEach(function(btn){
    btn.addEventListener('click', function(){
      var token = btn.getAttribute('data-token') || '';
      if (!token) return;

      function done() {
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-success');
        btn.innerHTML = '<i class="fas fa-check mr-1"></i> Copied';
        setTimeout(function(){
          btn.classList.remove('btn-success');
          btn.classList.add('btn-outline-primary');
          btn.innerHTML = '<i class="fas fa-copy mr-1"></i> Copy';
        }, 1200);
      }

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(token).then(done).catch(function(){});
      } else {
        // Fallback
        var ta = document.createElement('textarea');
        ta.value = token;
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand('copy'); done(); } catch(e) {}
        document.body.removeChild(ta);
      }
    });
  });
})();
</script>
{% endblock %}
