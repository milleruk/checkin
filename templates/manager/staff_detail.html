{% extends "sbadmin/base.html" %}
{% block title %}{{ staff_obj.name }}{% endblock %}

{% block content %}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
  <div>
    <div class="d-flex align-items-center">
      <a href="{% url 'manager_staff' site.id %}" class="btn btn-sm btn-outline-secondary mr-3">
        <i class="fas fa-arrow-left mr-1"></i> Back
      </a>
      <div>
        <h1 class="h3 mb-0 text-gray-800">{{ staff_obj.name }}</h1>
        <div class="small text-muted">{{ site.name }}</div>
      </div>
    </div>
  </div>
</div>

<!-- KPIs -->
<div class="row">
  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card border-left-success shadow h-100">
      <div class="card-body py-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Check-ins Today</div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ checkins_today }}</div>
          </div>
          <i class="fas fa-calendar-check fa-2x text-gray-300"></i>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card border-left-primary shadow h-100">
      <div class="card-body py-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Check-ins (7 days)</div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ checkins_week }}</div>
          </div>
          <i class="fas fa-chart-line fa-2x text-gray-300"></i>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card border-left-primary shadow h-100">
      <div class="card-body py-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Check-ins (3 months)</div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ checkins_3months }}</div>
          </div>
          <i class="fas fa-history fa-2x text-gray-300"></i>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card border-left-danger shadow h-100">
      <div class="card-body py-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Auto outs (7 days)</div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ auto_week }}</div>
          </div>
          <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <!-- LEFT: actions -->
  <div class="col-lg-5">
    <div class="card shadow mb-4">
      <div class="card-header py-3 d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <i class="fas fa-user-cog text-primary mr-2"></i>
          <h6 class="m-0 font-weight-bold text-primary">Staff Settings</h6>
        </div>
      </div>

      <div class="card-body">
        <div class="alert alert-info d-flex align-items-center justify-content-between mb-3">
          <div class="mb-0">
            <strong>Current PIN:</strong>
            <code id="currentPin" style="font-size:1.1em;">{{ staff_obj.pin_value }}</code>
          </div>
          <button type="button" class="btn btn-sm btn-outline-primary" id="copyPinBtn">
            <i class="fas fa-copy mr-1"></i> Copy
          </button>
        </div>

        <ul class="nav nav-pills mb-3" id="staffSettingsTabs" role="tablist">
          <li class="nav-item">
            <a class="nav-link active" id="rename-tab" data-toggle="pill" href="#rename-pane" role="tab">
              <i class="fas fa-edit mr-1"></i> Rename
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="pin-tab" data-toggle="pill" href="#pin-pane" role="tab">
              <i class="fas fa-key mr-1"></i> Reset PIN
            </a>
          </li>
        </ul>

        <div class="tab-content">
          <!-- Rename -->
          <div class="tab-pane fade show active" id="rename-pane" role="tabpanel">
            <form method="post">
              {% csrf_token %}
              <div class="form-group">
                <label class="mb-1">Name</label>
                <input class="form-control" name="name" maxlength="160" value="{{ staff_obj.name }}" required>
                {% if rename_form.name.errors %}<div class="text-danger small mt-1">{{ rename_form.name.errors.0 }}</div>{% endif %}
              </div>
              <button class="btn btn-secondary" name="rename" value="1">
                <i class="fas fa-save mr-1"></i> Save Name
              </button>
            </form>
          </div>

          <!-- Reset PIN -->
          <div class="tab-pane fade" id="pin-pane" role="tabpanel">
            <form method="post" id="resetPinForm">
              {% csrf_token %}
              <div class="form-group">
                <label class="mb-1">New PIN (6 digits)</label>
                <div class="input-group">
                  <input class="form-control" id="pinInput" name="pin"
                         maxlength="6" minlength="6" inputmode="numeric" required
                         value="{{ pin_form.pin.value|default:'' }}">
                  <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button" id="genPinBtn">
                      <i class="fas fa-dice mr-1"></i> Random
                    </button>
                  </div>
                </div>
                {% if pin_form.pin.errors %}<div class="text-danger small mt-1">{{ pin_form.pin.errors.0 }}</div>{% endif %}
              </div>

              <button class="btn btn-primary" name="reset_pin" value="1">
                <i class="fas fa-sync mr-1"></i> Reset PIN
              </button>

              <div class="small text-muted mt-2">
                Auto outs (3 months): <strong>{{ auto_3months }}</strong><br>
                Total hours on site (7d): <strong>{{ total_hours_7d }}</strong><br>
                First check-in (7d): <strong>{{ first_checkin_7d_time|date:'Y-m-d H:i'|default:'—' }}</strong><br>
                Last check-out (7d): <strong>{{ last_checkout_7d_time|date:'Y-m-d H:i'|default:'—' }}</strong>
              </div>
            </form>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- RIGHT: activity -->
  <div class="col-lg-7">
    <!-- Recent -->
    <div class="card shadow mb-4">
      <div class="card-header py-3 d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <i class="fas fa-bolt text-primary mr-2"></i>
          <h6 class="m-0 font-weight-bold text-primary">Recent Events</h6>
          <span class="badge badge-light ml-2">{{ recent_events|length }}</span>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm table-hover mb-0">
            <thead class="thead-light">
              <tr>
                <th class="pl-3">Time</th>
                <th>Direction</th>
              </tr>
            </thead>
            <tbody>
              {% for e in recent_events %}
                <tr>
                  <td class="pl-3">{{ e.occurred_at }}</td>
                  <td>
                    {% if e.direction|lower == "in" %}
                      <span class="badge badge-success">IN</span>
                    {% elif e.direction|lower == "out" %}
                      <span class="badge badge-secondary">OUT</span>
                    {% else %}
                      <span class="badge badge-light">{{ e.direction }}</span>
                    {% endif %}
                    {% if e.auto_clockout %}
                      <span class="badge badge-warning ml-2" title="Auto clock-out by system">auto</span>
                    {% endif %}
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="2" class="text-muted py-3 text-center">No events.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Full history -->
    <div class="card shadow mb-4">
      <div class="card-header py-3 d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <i class="fas fa-list text-primary mr-2"></i>
          <h6 class="m-0 font-weight-bold text-primary">Full History</h6>
          <span class="badge badge-light ml-2">{{ page_obj.paginator.count }}</span>
        </div>
        <input type="text" id="historyFilter" class="form-control form-control-sm"
               style="max-width:220px;" placeholder="Filter this page…">
      </div>

      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm table-hover mb-0" id="historyTable">
            <thead class="thead-light">
              <tr>
                <th class="pl-3">Date & Time</th>
                <th>Direction</th>
              </tr>
            </thead>
            <tbody>
              {% for e in page_obj %}
                <tr>
                  <td class="pl-3">{{ e.occurred_at }}</td>
                  <td>
                    {% if e.direction|lower == "in" %}
                      <span class="badge badge-success">IN</span>
                    {% elif e.direction|lower == "out" %}
                      <span class="badge badge-secondary">OUT</span>
                    {% else %}
                      <span class="badge badge-light">{{ e.direction }}</span>
                    {% endif %}
                    {% if e.auto_clockout %}
                      <span class="badge badge-warning ml-2" title="Auto clock-out by system">auto</span>
                    {% endif %}
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="2" class="text-muted py-4 text-center">No history found.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div id="noHistoryResults" class="text-center text-muted py-4" style="display:none;">
          No matching rows on this page.
        </div>

        <nav aria-label="Event pagination" class="p-3">
          <ul class="pagination mb-0">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Previous</span></li>
            {% endif %}

            <li class="page-item active">
              <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
            </li>

            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Next</span></li>
            {% endif %}
          </ul>
        </nav>
      </div>
    </div>

  </div>
</div>

<script>
(function () {
  // Random PIN
  var genPinBtn = document.getElementById('genPinBtn');
  if (genPinBtn) {
    genPinBtn.onclick = function() {
      document.getElementById('pinInput').value = '' + Math.floor(100000 + Math.random() * 900000);
    };
  }

  // Copy current PIN
  var copyBtn = document.getElementById('copyPinBtn');
  if (copyBtn) {
    copyBtn.addEventListener('click', function(){
      var pin = (document.getElementById('currentPin').innerText || '').trim();
      if (!pin) return;

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(pin);
      } else {
        var tmp = document.createElement('textarea');
        tmp.value = pin;
        document.body.appendChild(tmp);
        tmp.select();
        document.execCommand('copy');
        document.body.removeChild(tmp);
      }

      var original = copyBtn.innerHTML;
      copyBtn.innerHTML = '<i class="fas fa-check mr-1"></i> Copied';
      setTimeout(function(){ copyBtn.innerHTML = original; }, 1200);
    });
  }

  // Filter current history page
  var historyFilter = document.getElementById('historyFilter');
  var historyTable = document.getElementById('historyTable');
  var noRows = document.getElementById('noHistoryResults');

  function applyHistoryFilter() {
    if (!historyFilter || !historyTable) return;
    var q = (historyFilter.value || '').toLowerCase().trim();
    var rows = historyTable.querySelectorAll('tbody tr');
    var visible = 0;

    rows.forEach(function(row){
      var text = (row.innerText || '').toLowerCase();
      var show = (!q) || text.indexOf(q) !== -1;
      row.style.display = show ? '' : 'none';
      if (show) visible++;
    });

    if (noRows) noRows.style.display = (rows.length > 0 && visible === 0) ? '' : 'none';
  }

  if (historyFilter) historyFilter.addEventListener('input', applyHistoryFilter);
})();
</script>
{% endblock %}
