<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>{{ site.name }} - Scan</title>

  <style>
    :root{
      --bg0:#f5f7fb;
      --bg1:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:rgba(2,6,23,.10);
      --shadow: 0 10px 30px rgba(2,6,23,.08);
      --shadow2: 0 2px 10px rgba(2,6,23,.06);

      --brand:#2563eb;
      --brand2:#1d4ed8;

      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#dc2626;

      --radius:18px;
      --radiusSm:14px;
      --pad:18px;

      --ring: 0 0 0 4px rgba(37,99,235,.15);
    }

    * { box-sizing:border-box; }
    html, body { height:100%; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin:0;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 10% -10%, rgba(37,99,235,.12), transparent 55%),
        radial-gradient(900px 600px at 90% 0%, rgba(22,163,74,.10), transparent 50%),
        linear-gradient(180deg, var(--bg0), #eef2ff 45%, var(--bg0));
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0;
    }

    a { color:inherit; text-decoration:none; }

    .wrap{
      width: min(980px, 100%);
      padding: 22px 14px 34px;
    }

    /* Header */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }
    .logo{
      width:44px;height:44px;
      border-radius:14px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.75), transparent 60%),
        linear-gradient(135deg, var(--brand), #22c55e);
      box-shadow: var(--shadow2);
      border: 1px solid rgba(255,255,255,.45);
      flex:0 0 auto;
    }
    .brand h1{
      font-size: 18px;
      line-height:1.1;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 60vw;
    }
    .brand .sub{
      margin:2px 0 0 0;
      color:var(--muted);
      font-size:13px;
    }
    .pillRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    /* Buttons */
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.7);
      box-shadow: var(--shadow2);
      font-weight:600;
      font-size:14px;
      line-height:1;
      cursor:pointer;
      transition: transform .08s ease, box-shadow .15s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform: translateY(1px); box-shadow: 0 1px 6px rgba(2,6,23,.08); }
    .btn:focus-visible{ outline:none; box-shadow: var(--shadow2), var(--ring); }
    .btn.primary{
      background: linear-gradient(180deg, #111827, #0b1220);
      color:#fff;
      border-color: rgba(255,255,255,.08);
    }
    .btn.soft{
      background: rgba(255,255,255,.85);
    }
    .btn.link{
      background: transparent;
      box-shadow:none;
      border-color: transparent;
      color: var(--brand2);
      padding: 8px 10px;
    }

    /* Layout: desktop two-column, mobile single */
    .gridLayout{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }
    @media (min-width: 860px){
      .gridLayout{
        grid-template-columns: 1.15fr .85fr;
        align-items:start;
      }
    }

    /* Cards */
    .card{
      background: rgba(255,255,255,.82);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      overflow:hidden;
    }
    .cardHeader{
      padding: 14px var(--pad);
      border-bottom: 1px solid rgba(2,6,23,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .cardHeader .title{
      font-weight:800;
      font-size: 15px;
      margin:0;
      letter-spacing: .2px;
    }
    .cardBody{ padding: var(--pad); }

    /* Notices */
    .notice{
      border-radius: var(--radiusSm);
      padding: 12px 14px;
      border: 1px solid rgba(2,6,23,.08);
      background: rgba(255,255,255,.65);
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .notice .ico{ font-size: 18px; line-height:1; margin-top:1px; }
    .notice .txt{ font-size:14px; color: var(--text); }
    .notice .txt strong{ font-weight:800; }
    .notice .txt .muted{ color:var(--muted); font-weight:500; display:block; margin-top:4px; }

    .notice.ok{ border-left: 5px solid var(--ok); }
    .notice.warn{ border-left: 5px solid var(--warn); background: rgba(255,251,235,.75); }
    .notice.info{ border-left: 5px solid var(--brand); }

    /* PIN display */
    .pinBox{
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    .pin{
      font-size: 34px;
      letter-spacing: 10px;
      text-align:center;
      padding: 14px 0;
      border-radius: var(--radiusSm);
      border: 1px solid rgba(2,6,23,.12);
      background: rgba(248,250,252,.9);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.8);
      min-height: 56px;
    }
    .hintRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      color: var(--muted);
      font-size: 13px;
    }

    /* Keypad */
    .keypad{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 8px;
    }
    .keypad button{
      height: 56px;
      border-radius: 16px;
      border: 1px solid rgba(2,6,23,.12);
      background: rgba(255,255,255,.9);
      font-size: 20px;
      font-weight: 800;
      box-shadow: 0 1px 2px rgba(2,6,23,.06);
      transition: transform .06s ease, background .12s ease, border-color .12s ease, box-shadow .12s ease;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .keypad button:active{
      transform: translateY(1px);
      background: rgba(241,245,249,.95);
      box-shadow: 0 1px 1px rgba(2,6,23,.05);
    }
    .keypad button:focus-visible{ outline:none; box-shadow: var(--shadow2), var(--ring); }
    .keypad button.danger{
      color: var(--bad);
      border-color: rgba(220,38,38,.25);
      background: rgba(254,242,242,.9);
    }
    .keypad button.action{
      color: var(--brand2);
      border-color: rgba(37,99,235,.25);
      background: rgba(239,246,255,.9);
    }

    .msg{
      margin-top: 10px;
      min-height: 20px;
      font-size: 14px;
      color: var(--muted);
      text-align:center;
    }

    /* Action completed banner */
    .done{
      display:none;
      text-align:center;
      padding: 18px;
      border-radius: var(--radiusSm);
      background: rgba(22,163,74,.10);
      border: 1px solid rgba(22,163,74,.25);
      color: #14532d;
      font-weight:800;
    }

    /* Modal shared */
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    @keyframes popIn { from{transform:translateY(8px) scale(.98); opacity:.95} to{transform:translateY(0) scale(1); opacity:1} }

    .modal{
      display:none;
      position:fixed;
      inset:0;
      z-index:1100;
      background: rgba(2,6,23,.35);
      padding: 16px;
      align-items:center;
      justify-content:center;
      animation: fadeIn .14s ease;
    }
    .modalBox{
      width: min(520px, 100%);
      background: rgba(255,255,255,.95);
      border: 1px solid rgba(2,6,23,.12);
      border-radius: 22px;
      box-shadow: 0 18px 60px rgba(2,6,23,.25);
      padding: 18px 18px 14px;
      animation: popIn .14s ease;
      text-align:center;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .modalBox .bigIcon{ font-size: 44px; margin: 6px 0 6px; }
    .modalBox h2{ font-size: 18px; margin: 0 0 6px; font-weight: 900; }
    .modalBox h3{ margin: 6px 0 2px; font-size: 18px; }
    .modalBox p{ margin: 6px 0; color: var(--muted); font-size: 14px; }

    .modalBtns{
      display:flex;
      gap: 10px;
      margin-top: 12px;
    }
    .modalBtns .btn{
      flex:1;
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 15px;
    }

    /* Mobile tweaks */
    @media (max-width: 420px){
      .wrap{ padding: 16px 10px 26px; }
      .logo{ width:40px;height:40px; }
      .pin{ font-size: 30px; letter-spacing: 9px; }
      .keypad button{ height: 52px; }
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div style="min-width:0;">
          <h1>{{ site.name }}</h1>
          <div class="sub">Scan to check in / out</div>
        </div>
      </div>

      <div class="pillRow">
        {% if is_wfh %}
          <a href="{{ normal_scan_url }}" class="btn soft" aria-label="Switch to on-site sign-on">üè¢ On-site</a>
        {% else %}
          <a href="{{ wfh_url }}" class="btn soft" aria-label="Work from home sign-in">üè† WFH</a>
        {% endif %}
      </div>
    </div>

    <div class="gridLayout">

      <!-- MAIN: keypad -->
      <div class="card">
        <div class="cardHeader">
          <div class="title">Enter your 6-digit PIN</div>
          <a class="btn link" href="javascript:void(0)" id="helpToggle">Help</a>
        </div>

        <div class="cardBody">
          {% if is_wfh %}
            <div class="notice info" style="margin-bottom:12px;">
              <div class="ico">üè†</div>
              <div class="txt">
                <strong>Work From Home</strong>
                <span class="muted">This will be recorded as a remote session and won‚Äôt count as on-site roll-call.</span>
              </div>
            </div>
          {% endif %}

          <div id="helpBox" style="display:none; margin-bottom:12px;">
            <div class="notice ok">
              <div class="ico">‚úÖ</div>
              <div class="txt">
                <strong>How it works</strong>
                <span class="muted">Enter your PIN ‚Üí we suggest IN/OUT based on your last scan ‚Üí confirm or cancel. Use <b>CLR</b> or <b>‚å´</b> to correct.</span>
              </div>
            </div>
          </div>

          <div class="pinBox" id="step1">
            <div class="pin" id="pinDisplay" aria-label="PIN entry display">&nbsp;</div>

            <div class="hintRow">
              <span id="statusHint">Ready</span>
              <span>üîí Don‚Äôt share your PIN</span>
            </div>

            <div class="keypad" id="keypad" aria-label="PIN keypad"></div>
            <div class="msg" id="msg1"></div>

            <div class="notice warn" style="margin-top:12px;">
              <div class="ico">üîê</div>
              <div class="txt">
                <strong>PIN Security</strong>
                <span class="muted">All actions are logged and traceable to your PIN.</span>
              </div>
            </div>
          </div>

          <div class="done" id="actionedMsg">
            Action completed. Refresh this page to scan again.
          </div>
        </div>
      </div>

      <!-- SIDE: quick info / reassurance -->
      <div class="card">
        <div class="cardHeader">
          <div class="title">Quick tips</div>
        </div>
        <div class="cardBody" style="display:flex;flex-direction:column;gap:12px;">
          <div class="notice">
            <div class="ico">üëÜ</div>
            <div class="txt">
              <strong>Fastest flow</strong>
              <span class="muted">Type your PIN once ‚Äî the system auto-checks when you hit 6 digits.</span>
            </div>
          </div>

          <div class="notice">
            <div class="ico">üß†</div>
            <div class="txt">
              <strong>IN/OUT suggestion</strong>
              <span class="muted">We‚Äôll recommend based on your last scan to reduce mistakes.</span>
            </div>
          </div>

          <div class="notice">
            <div class="ico">üßπ</div>
            <div class="txt">
              <strong>Fix a typo</strong>
              <span class="muted"><b>‚å´</b> deletes one digit, <b>CLR</b> clears all.</span>
            </div>
          </div>

          <div class="notice">
            <div class="ico">‚è±Ô∏è</div>
            <div class="txt">
              <strong>Too fast?</strong>
              <span class="muted">If you see the timer popup, wait a moment and try again.</span>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- CONFIRM MODAL -->
  <div id="step2modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="step2headline">
    <div id="step2modalBox" class="modalBox">
      <div id="step2icon" class="bigIcon">‚úÖ</div>
      <h2 id="step2headline">Confirm action</h2>

      <h3 id="who" style="margin-top:8px;"></h3>
      <p id="last"></p>
      <p><strong>Suggested:</strong> <span id="suggested"></span></p>

      {% if is_wfh %}
        <p id="wfhNote"><span style="font-weight:700;">WFH:</span> this will be recorded as a remote session.</p>
      {% endif %}

      <div class="modalBtns" id="step2btnrow">
        <button class="btn primary" id="confirmBtn">Confirm</button>
        <button class="btn soft" id="cancelBtn">Cancel</button>
      </div>

      <div class="msg" id="msg2" style="margin-top:10px;"></div>
    </div>
  </div>

  <!-- SUCCESS POPUP -->
  <div id="popup" class="modal" style="z-index:1000;">
    <div class="modalBox">
      <div id="popupIcon" class="bigIcon">‚úÖ</div>
      <h2 id="popupMsg" style="margin-bottom:6px;"></h2>
      <p id="popupSub"></p>
      <div class="modalBtns" style="margin-top:10px;">
        <button id="popupClose" class="btn primary">OK</button>
      </div>
    </div>
  </div>

  <!-- FLOOD POPUP -->
  <div id="popupFlood" class="modal" style="z-index:1001;">
    <div class="modalBox">
      <div class="bigIcon" style="color:var(--warn);">‚è±Ô∏è</div>
      <h2 style="margin-bottom:6px;">You're too fast!</h2>
      <p>Please wait a moment before trying again.</p>
      <div class="modalBtns" style="margin-top:10px;">
        <button id="popupFloodClose" class="btn primary">OK</button>
      </div>
    </div>
  </div>

<script>
const token = "{{ token }}";
const csrf = "{{ csrf_token }}";
const resolveUrl = "{{ resolve_url }}";
const confirmUrl = "{{ confirm_url }}";
const normalScanUrl = "{{ normal_scan_url }}";
const isWFH = {{ is_wfh|yesno:"true,false" }};

let pin = "";
let payload = null;

const pinDisplay = document.getElementById("pinDisplay");
const keypad = document.getElementById("keypad");
const msg1 = document.getElementById("msg1");

const step1 = document.getElementById("step1");
const who = document.getElementById("who");
const last = document.getElementById("last");
const suggested = document.getElementById("suggested");
const msg2 = document.getElementById("msg2");
const statusHint = document.getElementById("statusHint");

const helpToggle = document.getElementById("helpToggle");
const helpBox = document.getElementById("helpBox");
helpToggle.onclick = () => {
  const on = helpBox.style.display !== "none";
  helpBox.style.display = on ? "none" : "block";
  helpToggle.textContent = on ? "Help" : "Hide";
};

function renderPin() {
  pinDisplay.textContent = pin.length ? "‚Ä¢".repeat(pin.length) : "\u00A0";
  statusHint.textContent = pin.length ? `${pin.length}/6 digits` : "Ready";
}

function btn(text, onClick, className){
  const b = document.createElement("button");
  b.type = "button";
  b.textContent = text;
  if (className) b.className = className;
  b.onclick = onClick;
  return b;
}

function reset(){
  pin=""; payload=null; msg1.textContent=""; msg2.textContent="";
  renderPin();
}

function closeModal(id){
  const el = document.getElementById(id);
  el.style.display = "none";
}

// Close modals on backdrop click + ESC
["step2modal","popup","popupFlood"].forEach(id=>{
  const el = document.getElementById(id);
  el.addEventListener("click", (e)=>{ if(e.target === el) closeModal(id); });
});
document.addEventListener("keydown", (e)=>{
  if(e.key === "Escape"){
    closeModal("step2modal");
    closeModal("popup");
    closeModal("popupFlood");
  }
});

// Modular popup for invalid PIN
function showPinError(msg) {
  let el = document.getElementById("popupPin");
  if (!el) {
    el = document.createElement("div");
    el.id = "popupPin";
    el.className = "modal";
    el.style.zIndex = 1002;
    el.style.display = "none";
    el.innerHTML = `
      <div class="modalBox" style="background:rgba(255,251,235,.95);border:1px solid rgba(245,158,11,.35);">
        <div class="bigIcon" style="color:var(--warn);">üîí</div>
        <h2 style="margin-bottom:6px;">PIN not recognised</h2>
        <p id="popupPinMsg" style="color:#854d0e;"></p>
        <div class="modalBtns" style="margin-top:10px;">
          <button id="popupPinClose" class="btn primary">OK</button>
        </div>
      </div>`;
    document.body.appendChild(el);
    el.addEventListener("click", (e)=>{ if(e.target === el) el.style.display="none"; });
    document.getElementById("popupPinClose").onclick = function() {
      el.style.display = "none";
    };
  }
  document.getElementById("popupPinMsg").textContent = msg;
  el.style.display = "flex";
}

async function resolvePin(){
  msg1.textContent = "Checking‚Ä¶";
  statusHint.textContent = "Checking‚Ä¶";

  const fd = new FormData();
  fd.append("pin", pin);
  fd.append("csrfmiddlewaretoken", csrf);

  const res = await fetch(resolveUrl, {method:"POST", body: fd});
  const data = await res.json();

  if(!res.ok){
    const err = (data && data.error) ? String(data.error) : "";
    const low = err.toLowerCase();

    if((low.includes("flood") || low.includes("spam") || low.includes("too soon") || res.status === 429)) {
      document.getElementById("popupFlood").style.display = "flex";
      reset();
      return;
    }
    if (res.status === 401 || low.includes("not recognised")) {
      showPinError(err || "PIN not recognised.");
      reset();
      return;
    }

    msg1.textContent = err || "Error";
    reset();
    return;
  }

  payload = data;
  who.textContent = data.staff_name;

  if (data.last_direction && data.last_at) {
    const lastDate = new Date(data.last_at);
    const dateStr = lastDate.toLocaleDateString();
    const timeStr = lastDate.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
    last.textContent = `Last: ${data.last_direction} at ${dateStr} ${timeStr}`;
  } else {
    last.textContent = "No previous scans";
  }

  suggested.textContent = data.suggested;

  // Style modal based on suggestion
  const modalBox = document.getElementById("step2modalBox");
  const icon = document.getElementById("step2icon");
  const headline = document.getElementById("step2headline");
  const confirmBtn = document.getElementById("confirmBtn");

  modalBox.style.background = "rgba(255,255,255,.95)";
  modalBox.style.borderColor = "rgba(2,6,23,.12)";
  confirmBtn.className = "btn primary";

  if (data.suggested === "IN") {
    modalBox.style.borderColor = "rgba(22,163,74,.35)";
    modalBox.style.background = "rgba(240,253,244,.92)";
    icon.textContent = "üü¢";
    headline.textContent = "Check IN now?";
    confirmBtn.style.background = "linear-gradient(180deg, #16a34a, #15803d)";
    confirmBtn.style.borderColor = "rgba(22,163,74,.35)";
  } else if (data.suggested === "OUT") {
    modalBox.style.borderColor = "rgba(220,38,38,.35)";
    modalBox.style.background = "rgba(254,242,242,.92)";
    icon.textContent = "üî¥";
    headline.textContent = "Check OUT now?";
    confirmBtn.style.background = "linear-gradient(180deg, #dc2626, #b91c1c)";
    confirmBtn.style.borderColor = "rgba(220,38,38,.35)";
  } else {
    icon.textContent = "‚úÖ";
    headline.textContent = "Confirm action";
    confirmBtn.style.background = "";
    confirmBtn.style.borderColor = "";
  }

  document.getElementById("step2modal").style.display = "flex";
  statusHint.textContent = "Ready";
}

function showPopup(direction, at) {
  document.getElementById("step1").style.display = "none";
  document.getElementById("actionedMsg").style.display = "block";

  const popup = document.getElementById("popup");
  const popupMsg = document.getElementById("popupMsg");
  const popupSub = document.getElementById("popupSub");
  const popupIcon = document.getElementById("popupIcon");

  popupMsg.textContent = `Action completed: ${direction}`;
  popupIcon.textContent = direction === "IN" ? "üü¢" : direction === "OUT" ? "üî¥" : "‚úÖ";

  if (isWFH) {
    popupSub.innerHTML = `Time: ${at}<br><strong>Recorded as WFH.</strong>`;
    let backBtn = document.getElementById('backToOnsiteBtn');
    if (!backBtn) {
      backBtn = document.createElement('a');
      backBtn.href = normalScanUrl;
      backBtn.id = 'backToOnsiteBtn';
      backBtn.className = 'btn soft';
      backBtn.style.marginTop = '10px';
      backBtn.textContent = 'Switch to On-site sign-on';
      popup.querySelector(".modalBox").appendChild(backBtn);
    }
  } else {
    popupSub.textContent = `Time: ${at}`;
    const existing = document.getElementById('backToOnsiteBtn');
    if (existing) existing.remove();
  }
  popup.style.display = "flex";
}

async function confirm(){
  msg2.textContent = "Saving‚Ä¶";

  const fd = new FormData();
  fd.append("staff_id", payload.staff_id);
  fd.append("direction", payload.suggested);
  fd.append("csrfmiddlewaretoken", csrf);

  const res = await fetch(confirmUrl, {method:"POST", body: fd});
  const data = await res.json();

  if(!res.ok){
    const err = (data && data.error) ? String(data.error) : "";
    const low = err.toLowerCase();
    if(low.includes("flood") || low.includes("spam") || low.includes("too fast") || res.status === 429) {
      document.getElementById("popupFlood").style.display = "flex";
      return;
    }
    msg2.textContent = err || "Error";
    return;
  }

  showPopup(data.direction, new Date(data.at).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"}));
  closeModal("step2modal");
  reset();
}

document.getElementById("confirmBtn").onclick = function() {
  confirm();
};
document.getElementById("cancelBtn").onclick = function() {
  closeModal("step2modal");
  reset();
};

// Keypad
const keys = ["1","2","3","4","5","6","7","8","9","CLR","0","‚å´"];
keys.forEach(k=>{
  let cls = "";
  if (k === "CLR") cls = "danger";
  if (k === "‚å´") cls = "action";

  keypad.appendChild(btn(k, ()=>{
    msg1.textContent="";
    if(k==="CLR"){ reset(); return; }
    if(k==="‚å´"){ pin = pin.slice(0,-1); renderPin(); return; }
    if(pin.length<6){ pin+=k; renderPin(); }
    if(pin.length===6){ resolvePin(); }
  }, cls));
});

// Popup close handlers
document.getElementById("popupClose").onclick = function() {
  closeModal("popup");
  const btn = document.getElementById('backToOnsiteBtn');
  if (btn) btn.remove();
};
document.getElementById("popupFloodClose").onclick = function() {
  closeModal("popupFlood");
};

renderPin();
</script>
</body>
</html>
